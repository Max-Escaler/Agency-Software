jQuery.fn.clockpick=function(r,s){var u={starthour:8,endhour:18,showminutes:true,minutedivisions:4,military:false,event:'click',layout:'vertical',valuefield:null,useBgiframe:false,hoursopacity:1,minutesopacity:1};if(r){jQuery.extend(u,r)};var s=s||function(){},v=(u.layout=='vertical');errorcheck();jQuery(this)[u.event](function(e){var g=this,$self=jQuery(this),$body=jQuery("body");if(!u.valuefield){$self.unbind("keydown").bind("keydown",keyhandler)}else{var j=jQuery("[name="+u.valuefield+"]");j.unbind("keydown").bind("keydown",keyhandler)[0].focus();j.bind("click",function(){j.unbind("keydown")})}jQuery("#CP_hourcont,#CP_minutecont").remove();var k=jQuery("<div id='CP_hourcont' class='CP' />").appendTo($body);!u.useBgiframe?k.css("opacity",u.hoursopacity):null;binder(k);var o=jQuery("<div class='CP_hourcol' id='hourcol1' />").appendTo($body);var p=jQuery("<div class='CP_hourcol' id='hourcol2' />").appendTo($body);if(u.showminutes){var q=jQuery("<div id='CP_minutecont' class='CP' />").appendTo($body);!u.useBgiframe?q.css("opacity",u.minutesopacity):null;binder(q)}if(!v){k.css("width","auto");if(u.showminutes){q.css("width","auto")}}else{o.addClass('floatleft');p.addClass('floatleft')}renderhours();putcontainer();function renderhours(){var c=1;for(var h=u.starthour;h<=u.endhour;h++){if(h==12){c=1}var a=((!u.military&&h>12)?h-12:h);if(!u.military&&h==0){a='12'}if(u.military&&h<10){a='0'+a}var b=jQuery("<div class='CP_hour' id='hr_"+h+"_"+c+"'>"+a+set_tt(h)+"</div>");if(u.military){b.width(20)}binder(b);if(!v){b.css("float","left")}(h<12)?o.append(b):p.append(b);c++}k.append(o);!v?k.append("<div style='clear:left' />"):'';k.append(p)}function renderminutes(h){var a=h;var b=(!u.military&&h>12)?h-12:h;if(!u.military&&h==0){b='12'}if(u.military&&h<10){b='0'+b}q.empty();var n=60/u.minutedivisions,tt=set_tt(a),counter=1;for(var m=0;m<60;m=m+n){$md=jQuery("<div class='CP_minute' id='"+a+"_"+m+"'>"+b+":"+((m<10)?"0":"")+m+tt+"</div>");if(!v){$md.css("float","left");if(u.minutedivisions>6&&counter==u.minutedivisions/2+1){q.append("<div style='clear:left' />")}}q.append($md);binder($md);counter++}}function set_tt(a){if(!u.military){return(a>=12)?' PM':' AM'}else{return''}}function putcontainer(){if(e.type!='focus'){k[0].style.left=e.pageX-5+'px';k[0].style.top=e.pageY-(Math.floor(k.height()/2))+'px';rectify(k)}else{$self.after(k)}k.slideDown('fast');if(u.useBgiframe)bgi(k)}function rectify(a){var b=document.documentElement.clientHeight?document.documentElement.clientHeight:document.body.clientHeight;var c=document.documentElement.clientWidth?document.documentElement.clientWidth:document.body.clientWidth;var t=parseInt(a[0].style.top);var l=parseInt(a[0].style.left);var d=document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop;if(t<=d&&!a.is("#CP_minutecont")){a.css("top",d+10+'px')}else if(t+a.height()-d>b){a.css("top",d+b-a.height()-10+'px')}if(l<=0){a.css("left",'10px')}}function bgi(a){if(typeof jQuery.fn.bgIframe=='function')a.bgIframe();else alert('bgIframe plugin not loaded.')}function binder(a){if(a.attr("id")=='CP_hourcont'){a.mouseout(function(e){hourcont_out(e)})}else if(a.attr("id")=='CP_minutecont'){a.mouseout(function(e){minutecont_out(e)})}else if(a.attr("class")=='CP_hour'){a.mouseover(function(e){hourdiv_over(a,e)});a.mouseout(function(){hourdiv_out(a)});a.click(function(){hourdiv_click(a)})}else if(a.attr("class")=='CP_minute'){a.mouseover(function(){minutediv_over(a)});a.mouseout(function(){minutediv_out(a)});a.click(function(){minutediv_click(a)})}};function hourcont_out(e){try{var t=(e.toElement)?e.toElement:e.relatedTarget;if(!(jQuery(t).is("div[class^=CP], iframe"))){cleardivs()}}catch(e){cleardivs()}}function minutecont_out(e){try{var t=(e.toElement)?e.toElement:e.relatedTarget;if(!(jQuery(t).is("div[class^=CP], iframe"))){cleardivs()}}catch(e){cleardivs()}}function hourdiv_over(a,e){var h=a.attr("id").split('_')[1],i=a.attr("id").split('_')[2],l,t;a.addClass("CP_over");if(u.showminutes){q.hide();renderminutes(h);if(v){t=e.type=='mouseover'?e.pageY-15:k.offset().top+2+(a.height()*i);if(h<12)l=k.offset().left-q.width()-2;else l=k.offset().left+k.width()+2}else{l=(e.type=='mouseover')?e.pageX-10:k.offset().left+(a.width()-5)*i;if(h<12){t=k.offset().top-q.height()-2}else{t=k.offset().top+k.height()}}q.css("left",l+'px').css("top",t+'px');rectify(q);q.show();if(u.useBgiframe)bgi(q)}return false}function hourdiv_out(a){a.removeClass("CP_over");return false}function hourdiv_click(a){var h=a.attr("id").split('_')[1],tt=set_tt(h),str=a.text();if(str.indexOf(' ')!=-1){var b=str.substring(0,str.indexOf(' '))}else{var b=str}a.text(b+':00'+tt);setval(a);cleardivs()}function minutediv_over(a){a.addClass("CP_over");return false}function minutediv_out(a){a.removeClass("CP_over");return false}function minutediv_click(a){setval(a);cleardivs()}function setval(a){if(!u.valuefield){g.value=a.text()}else{jQuery("input[name="+u.valuefield+"]").val(a.text())}s.apply($self,[a.text()]);$self.unbind("keydown",keyhandler)}function cleardivs(){if(u.showminutes){q.hide()}k.slideUp('fast');$self.unbind("keydown",keyhandler)}function keyhandler(e){var d=$("div.CP_over").size()?$("div.CP_over"):$("div.CP_hour:first"),divtype=d.is(".CP_hour")?'hour':'minute',hi=(divtype=='hour')?d[0].id.split('_')[2]:0,h=(divtype=='minute')?d[0].id.split('_')[0]:d[0].id.split('_')[1];if(divtype=='minute'){var f=h<12?'m1':'m2'}else{var f=h<12?'h1':'h2'}function divprev(a){if(a.prev().size()){eval(divtype+'div_out($obj)');eval(divtype+'div_over($obj.prev(), e)')}else{return false}}function divnext(a){if(a.next().size()){eval(divtype+'div_out($obj)');eval(divtype+'div_over($obj.next(), e)')}else{return false}}function hourtohour(a){var b=h>=12?'#hourcol1':'#hourcol2';$newobj=jQuery(".CP_hour[id$=_"+hi+"]",b);if($newobj.size()){hourdiv_out(a);hourdiv_over($newobj,e)}else{return false}}function hourtominute(a){hourdiv_out(a);minutediv_over($(".CP_minute:first"))}function minutetohour(a){minutediv_out(a);var b=h>=12?'#hourcol2':'#hourcol1';var c=jQuery(".CP_hour[id^=hr_"+h+"]",b);hourdiv_over(c,e)}switch(e.keyCode){case 37:if(v){switch(f){case'm1':return false;break;case'm2':minutetohour(d);break;case'h1':hourtominute(d);break;case'h2':hourtohour(d);break}}else{divprev(d)}break;case 38:if(v){divprev(d)}else{switch(f){case'm1':return false;break;case'm2':minutetohour(d);break;case'h1':hourtominute(d);break;case'h2':hourtohour(d);break}}break;case 39:if(v){switch(f){case'm1':minutetohour(d);break;case'm2':return false;break;case'h1':hourtohour(d);break;case'h2':hourtominute(d);break}}else{divnext(d)}break;case 40:if(v){divnext(d)}else{switch(f){case'm1':minutetohour(d);break;case'm2':return false;break;case'h1':hourtohour(d);break;case'h2':hourtominute(d);break}}break;case 13:eval(divtype+'div_click($obj)');break;default:return true}return false}return false});function errorcheck(){if(u.starthour>=u.endhour){alert('Error - start hour must be less than end hour.');return false}else if(60%u.minutedivisions!=0){alert('Error - param minutedivisions must divide evenly into 60.');return false}}return this}